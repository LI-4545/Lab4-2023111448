name: Java CI with Maven and Smart Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main", "master" ]

jobs:
  # ---------------------------------------------------
  # ç¬¬ä¸€é˜¶æ®µï¼šè¿è¡Œ Maven æµ‹è¯•
  # ---------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with Maven
        # ä½¿ç”¨ -B (Batch mode) å‡å°‘æ—¥å¿—å†—ä½™
        run: mvn -B test --file pom.xml

  # ---------------------------------------------------
  # ç¬¬äºŒé˜¶æ®µï¼šè‡ªåŠ¨åˆå¹¶ (å¸¦è¯„è®ºåŠŸèƒ½)
  # ---------------------------------------------------
  auto-merge:
    needs: test
    # å®‰å…¨æ£€æŸ¥ï¼šä»…å½“æµ‹è¯•é€šè¿‡ï¼Œä¸” PR å¹¶éæ¥è‡ª Fork ä»“åº“ï¼ˆé˜²æ­¢æ¶æ„ä»£ç åˆ©ç”¨ä½ çš„ Tokenï¼‰æ—¶è¿è¡Œ
    if: |
      needs.test.result == 'success' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: write
      issues: write  # éœ€è¦æ­¤æƒé™æ¥å‘è¡¨è¯„è®º

    steps:
      - name: Auto merge logic
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { owner, repo } = context.repo;

            // 1. è·å– PR è¯¦æƒ…ä»¥æ£€æŸ¥æ˜¯å¦å¯åˆå¹¶ (mergeable çŠ¶æ€)
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            if (pr.mergeable) {
              // 2. å‘é€â€œå¼€å§‹åˆå¹¶â€è¯„è®º
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: 'âœ… æµ‹è¯•é€šè¿‡ï¼Œæ£€æµ‹åˆ°æ— å†²çªï¼Œå‡†å¤‡è‡ªåŠ¨åˆå¹¶...'
              });

              try {
                // 3. æ‰§è¡Œåˆå¹¶æ“ä½œ
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prNumber,
                  commit_title: `Merge pull request #${prNumber} (Auto-merged)`,
                  commit_message: `Auto-merged by GitHub Actions after passing tests.`,
                  merge_method: 'merge' // å¯é€‰: 'squash', 'rebase'
                });

                // 4. å‘é€â€œæˆåŠŸâ€è¯„è®º
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: 'ğŸ‰ PR å·²æˆåŠŸè‡ªåŠ¨åˆå¹¶ï¼'
                });

              } catch (error) {
                // 5. æ•è·åˆå¹¶é”™è¯¯ï¼ˆå¦‚ä¸´æ—¶å˜åŠ¨å¯¼è‡´çš„å†²çªï¼‰
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `âŒ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œè¯·äººå·¥ä»‹å…¥ã€‚\n\né”™è¯¯ä¿¡æ¯: ${error.message}`
                });
                core.setFailed(error.message);
              }

            } else {
              // 6. å¦‚æœ GitHub åˆ¤æ–­æœ‰å†²çª
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: 'âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œæ— æ³•è‡ªåŠ¨åˆå¹¶ã€‚è¯·æ‰‹åŠ¨è§£å†³å†²çªåå†è¯•ã€‚'
              });
              core.setFailed('PR has merge conflicts.');
            }
